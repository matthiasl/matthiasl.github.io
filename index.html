<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Strict//EN'
          'http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
  <head>
    <title>
      Matthias Lang's personal blog</title>
    <link rel='stylesheet' type='text/css' media='screen' href='./style.css'/>
  </head>
  <body>
    <div id='outer'>
      <div id='masthead'>
        <a href='index.html'>Matthias' personal blog</a><br/></div>
      <div id='about'>
        <h3>
          ABOUT</h3>

        <p>
          This is my personal blog. I also write on
          <a href='https://corelatus.com/blog'>the Corelatus blog</a>.
        </p>

        <p>
          <a href='mailto:matthias@corelatus.com'>matthias@corelatus.com</a>
        </p>
      </div>

      <div id='articles'>
        <!--- ========================================================= --->
        <h2>Watermarking a PDF with ghostscript</h2>
        <p class='posted'>
          <em>Posted December 7th. 2016</em></p>

        <p>
          Transforming an existing PDF so that it gets something like
          'Draft' stamped across each page is surprisingly easy with
	  ghostscript. Shell script:
        </p>

        <pre>
#!
# Add a watermark to a PDF file
#
# first argument: the filename
# second argument: the watermark text (default "watermark")

filename=$1
watermark=$2

if [ x$2 == x ]; then watermark="watermark"; fi

cat &gt; /tmp/watermark.ps &lt;&lt; HERE
&lt;&lt;
   /EndPage
   {
     2 eq { pop false }
     {
         gsave
         0.5 .setopacityalpha
         /Helvetica_Bold 120 selectfont
         .65 setgray 130 70 moveto 50 rotate ($watermark) show
         grestore
         true
     } ifelse
   } bind
&gt;&gt; setpagedevice
HERE

gs -dBATCH -dNOPAUSE -q -sDEVICE=pdfwrite -sOutputFile=watermarked_$filename /tmp/watermark.ps $filename
        </pre>

        <p>
          There are three tricks above. First, you have to know about
          the 'EndPage' hook in postscript. It's code executed at the
          end of each page. Second, you have to know that the
          parameter can be 0, 1 or 2, depending on the reason for the
          'EndPage'. The postscript reference manual explains what the
          codes mean, but we're interested in all but 2. Third,
          there's the '.setopacityalpha' operator, which I think only
          works in PostScript 1.4, but that's OK because that's pretty
          standard now.
        </p>

        <p>
	  (And, yes, I know, the temporary file is ugly. Sorry.)
        </p>
	<hr/>

        <!--- ========================================================= --->
        <h2>
          OpenWrt on a TP-Link TL-WR1043N/ND v3</h2>
        <p class='posted'>
          <em>Posted December 5th 2016</em></p>

        <p>
          Getting this to work was surprisingly rough. I ran into
          trouble with OpenWrt versions, broken old config and
          interface name confusion. But it's nice now that it works.
        </p>

        <h3>Firmware update</h3>
        <p>
          The current (2016-12) stable version of OpenWrt is "Chaos
          Calmber 15.05.1". That version has support for v1 and v2 of
          my access point, but not v3. According to one page I found,
          you can hack (by editing one byte) the v2 image to install
          it on a v3 device, but that seemed too risky. I installed
          a daily snapshot from a few days back instead.
        </p>

        <p>
          I did the install via the CLI, using 'scp' to copy the file
          to /tmp and 'sysupgrade' to do the install.
        </p>

        <h3>LUCI</h3>

        <p>
          Snapshots don't include LUCI, the browser UI. So I installed
          that with 'opkg update' and 'opkg install luci'.
        </p>

        <h3>Old/Broken settings</h3>

        <p>
          Both before and after upgrading, the wired interfaces on
          the access point worked fine but the wireless was 'disabled'
          no matter what I did. I couldn't figure out what was wrong and
          ended up re-installing the firmware via LUCI and unchecking the
          'retain settings' box. After that, wireless worked.
        </p>

        <h3>Guest wireless</h3>

        <p>
          Mostly for fun, I set up an unencrypted guest network alongside
          my regular network. I did that entirely in LUCI. I put it
          in its own network, 'guest_nw'. To get that talking to the
          outside world, I had to add forwarding to the 'wan'.
        </p>

        <p>
          I also installed 'SQM QOS', i.e. 'opkg install ...' and
          limited the bandwidth for the guest network. It's a bit
          tricky to figure out which 'interface name' relates to
          which wireless network, in my case it was 'wlan0-1'.
        </p>

	<hr/>
        <!--- ========================================================= --->
        <h2>
          Adjusting the external monitor backlight</h2>
        <p class='posted'>
          <em>Posted November 30th 2016</em></p>

        <pre>
          sudo apt-get install i2c-tools
          sudo modprobe i2c-dev
          ddccontrol dev:/dev/i2c-7 -r 0x10 -w 15
        </pre>

        <p>
          'i2cdetect -l' is useful for finding if there is an I2C
          adaptor.  The register number, 0x10, can be read out by
          running 'ddccontrol' without arguments.
        </p>

        <p>
          Addendum: to make the above work without 'sudo' and without
	having the manually load a module:</p>

        <pre>
           sudo adduser <username> i2c
           sudo /bin/sh -c 'echo i2c-dev >> /etc/modules'
        </pre>

	<hr/>
        <!--- ========================================================= --->
        <h2>
          Fixing Linux/Windows dual boot on my Thinkpad 13</h2>
        <p class='posted'>
          <em>Posted November 28th 2016</em></p>

        <p>
          My Thinkpad 13 dual-boots Windows and Debian. Yesterday,
          Windows update ran and after that 'grub' stopped appearing
          at boot time. Annoying.
        </p>

        <p>
          I fixed it by downloading the debian <em>stretch</em> CD,
          the first one, putting it on a USB stick:
        </p>

        <pre>
          wget http://cdimage.debian.org/cdimage/stretch_di_alpha8/amd64/iso-cd/debian-stretch-DI-alpha8-amd64-xfce-CD-1.iso
          dd if=debian-stretch-DI-alpha8-amd64-xfce-CD-1.iso of=/dev/sdXXX bs=4M
        </pre>

        <p>
        In the second line above, change 'sdXXX' to the USB device. In my
        case 'sdb'. To boot from USB, I fiddled with the BIOS settings:
        </p>

        <pre>
          secureboot: disabled
          UEFI/legacy: both
          UEFI first
        </pre>

        <p>
          I made sure the USB stick was in the boot list and booted
          the Debian installer, put it in rescue mode and re-installed
          'grub' to sda (the SSD).
        </p>

        <p>
          Pitfall: you can't use the 'jessie' install CD to rescue a
          stretch installation. Attempting to run the grub reinstall
          gets an error.
        </p>

        <p>
          Pitfall: Lenovo's BIOS seems buggy. If you plug in a USB stick
          while in the boot menu, the BIOS hangs, sometimes.
        </p>

        <p>
          Pitfall: Lenovo's BIOS doesn't tell you when a boot attempt
          failed, it just bounces back to the boot screen.
        </p>

        <p>
          Annoyance: Windows (Windows 10, I think) seemed to do a
          major update without warning. It just said "Working on
          updates 15%. Don't turn off your PC. This will take a while.
          Your PC will restart several times." It ended up downloading
          things for five or ten minutes (on WiFi backed by a 100Mbit
          fiber) and when it was done, Grub was nuked. Not nice. This
          is one of the reasons I don't run Windows on my main
          machine.
        </p>

	<hr/>

        <!--- ========================================================= --->
        <h2>
          Fixing video tearing in X (and a glance at Wayland)</h2>
        <p class='posted'>
          <em>Posted November 21st 2016</em></p>

        <p>
          I've used pretty much the same X setup since 1993. I'm happy
          with it. I want minimal window decorations, no click to
          focus and alt+tab to get me a new xterm and three virtual
          desktops. I don't want menus, status bars, clocks, animated
          window movement or anything like that.
        </p>

        <p>
          But... one thing was annoying me. When scrolling some sites,
          such as stack overflow, the browser window gets a diagonal
          tear in it. It's easiest to see in video, wikipedia has a
          reasonable <a href='https://en.wikipedia.org/wiki/Screen_tearing'>
          article with pictures</a>. Fixing this should be easy:
          redraw the screen during the vertical blanking interval.
          That's not a new idea, even the Commodore 64 had an
          interrupt you could trigger when a particular scanline was
          passed.
        </p>

        <p>
          The fix I ended up using was to create /etc/X11/xorg.conf with
          the TearFree option set:
        </p>

        <pre>
          # 2016-11-21 Debian default Xorg install doesn't have this file.
          #            MML added it to get the TearFree option.
          Section "Device"
          Identifier "Intel inbuilt graphics"
          Driver "intel"
          Option "TearFree" "true"
          EndSection
        </pre>

        <p>
          Fixes the problem completely. But... before I did that, I
          also tried a few other fixes.
        </p>

        <p>
          First, I tried switching to 'Wayland'. Wayland is a
          replacement for X. I've been meaning to take a look at it
          for a while. It's in Debian testing, so all I did is install
          'weston', shut down X and start 'weston-launch'. That works
          fine in the sense that it gets me a display and I can start
          a terminal in it. But nothing else works. No emacs outside
          the terminal, no firefox, no mplayer. I could probably get
          some or all of those to work with some more fiddling, but
          I'm not <em>that</em> interested. I'll probably take another
          look at Wayland in a year.
        </p>

        <p>
          Next, I tried running 'compton', which basically does the
          same thing as the TearFree option in the X server, but at a
          higher level. Compton changed the colour of my root window,
          but didn't fix the tearing. I tried the --dbe option and
          each of the five --vsync options. Didn't work. It also
          seemed to freeze up twice, getting my machine back required
          'kill -9' from a console, so I gave on on 'compton' fairly quickly.
        </p>

        <p>
          Finally, I tried the 'xfce4' window manager. It has a
          non-default option to do compositing, which is again
          basically the same thing as the TearFree option in the X
          server. It's in Manager/window manager tweaks/compositor/
          Works fine, but I didn't really want to switch window managers.
          I'm perfectly happy with openbox.
        </p>
        <hr/>

        <!--- ========================================================= --->
        <h2>
          Using a 'bash' function to silence GTK 3.20</h2>
        <p class='posted'>
          <em>Posted October 5th 2016</em></p>

        <p>
          Emacs and mutt started spewing warnings in my xterms a month
          or two ago. They look like this:
        </p>

        <pre>
(emacs:7719): Gtk-WARNING **: GtkWindow 0xd32290 is drawn without a current allocation. This should not happen.

(emacs:7719): Gtk-WARNING **: GtkWindow 0xd32290 is drawn without a current allocation. This should not happen.

(emacs:7719): Gtk-WARNING **: EmacsFixed 0xd36130 is drawn without a current allocation. This should not happen.

(emacs:7719): Gtk-WARNING **: EmacsFixed 0xd36130 is drawn without a current allocation. This should not happen.
        </pre>

        <p>
          The warnings annoy me. They're not relevant to what I'm doing;
          they're a GTK problem or an emacs problem. I silenced the
          warnings by adding this to my .bashrc:
        </p>

        <pre>
# 2016-10. GTK has an annoying new warning which causes emacs and lots
# of other X program to spew things like "GtkWindow 0xd34290 is drawn..."
# on stderr. So we have this function which redirects emacs and mutt stderr
# to /dev/null
#
# We can remove this when GTK disable the warning again, which will
# probably happen by 2017-06.
emacs()
{
  /usr/bin/emacs $* 2>/dev/null
}

mutt()
{
  /usr/bin/mutt $* 2>/dev/null
}
        </pre>

        <p>
          This lets me type 'emacs myfile.txt' and get an emacs started
          which doesn't dump rubbish in my terminal.
        </p>

        <p>
          (I could have used an <emph>alias</emph> for 'mutt', since I
          pretty much always run mutt without arguments. But for 'emacs'
          I had to use a function because I want the arguments passed.)
        </p>

        <p>
          FWIW, here's the
          <a href='https://mail.gnome.org/archives/commits-list/2016-May/msg06553.html'>
            commit</a> that made GTK dump debugging information to
          stderr by default. And here's
          the <a href='https://git.gnome.org/browse/gtk+/commit/?id=54fdcb3ffac3383432b379f3e16e8cb0086b8101'>commit</a>
          which fixed it again.
        </p>

        <p>
          Edit 2016-11-21: underlying problem is now fixed in Debian
          testing, so the above workaround is no longer needed.
        </p>

        <hr/>

        <!--- ========================================================= --->
        <h2>
          Post-LinkedIn Profile</h2>
        <p class='posted'>
          <em>Posted September 14th 2016</em></p>

        <p>
          I've reduced my LinkedIn network to zero contacts, by hitting
          'remove' on each contact. That lets me keep a LinkedIn account to
          view people's profiles without having to wade through bogus
          endorsements and easily ignore Linkedin nagging me to expand my
          network.
        </p>

        <p>
          I figure I may as well just put my Linkedin profile here, since
          Linkedin arbitrarily hides it unless you 'upgrade your account'.
        </p>

        <div style='background: #e0e0e0; padding: 10px;'>
        <h3>Matthias Lang</h3>

        <h4>Experience</h4>
        <p>
          <strong>Owner</strong><br/>
          Corelatus<br/>
          October 2000 &ndash; present (many years)
        </p>

        <p>
          I am one of the four co-founders.
        </p>

        <p>
          I write software on Corelatus' own hardware, dividing my time
          roughly evenly between writing for TI DSPs, C on linux and
          Erlang. Most of that is telecom-specific, e.g. the lower levels of
          SS7 and ATM and signal processing.
        </p>

        <p>
          <strong>Engineer</strong><br/>
          Ericsson Computer Science Laboratory<br/>
          Stockholm, Sweden<br/>
          February 1999 &ndash; September 2000 (1 year 8 months)
        </p>

        <p>
          <strong>Engineer</strong><br/>
          Advanced Services Application Center (joint venture Ericsson and Melbourne IT)<br/>
          Melbourne, Australia<br/>
          1997 &ndash; 1999 (2 years)
        </p>

        <h4>Formal education</h4>

        <p>
          <strong>University of Melbourne</strong><br/>
          B.Eng, Elec. Engineering<br/>
          1992 &ndash; 1996
        </p>
        </div>

      </div>
    </div>
  </body>
</html>
